<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Demo Link Generator</title>
    <!-- Using Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: linear-gradient(to right, #1e3a8a, #3b82f6); }
        #bulkResult a { word-break: break-all; }
        #bulkResult li { border-bottom: 1px solid #374151; }
        #bulkResult li:last-child { border-bottom: none; }
    </style>
</head>
<body class="font-sans antialiased text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4">
        
        <div class="text-center mb-8">
            <div class="w-48 mx-auto mb-2">
                <img src="./CSReplay Logo.png" alt="CSReplay Logo">
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">Bulk Demo Link Generator</h1>
            <p class="text-blue-200">Paste multiple Share Codes or links below, one per line.</p>
        </div>

        <form id="shareCodeForm">
            <div class="mb-4">
                <textarea 
                    id="shareCodeInput"
                    placeholder="CSGO-xxxxx-xxxxx...
CSGO-yyyyy-yyyyy...
https://csstats.gg/match/..."
                    class="w-full px-4 py-3 bg-gray-700 text-white border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300 h-48"
                    required
                ></textarea>
            </div>
            <button 
                type="submit" 
                id="submitButton"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105 flex items-center justify-center"
            >
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="buttonText">Get Download Links</span>
            </button>
        </form>

        <div id="result" class="mt-8 p-6 bg-gray-900 rounded-lg text-center min-h-[80px] flex items-center justify-center transition-all duration-300">
            <p class="text-gray-400">Your results will appear here...</p>
        </div>
        
        <div class="text-center mt-4">
             <a href="/index.html" class="text-blue-300 hover:text-white underline">Back to single link generator</a>
        </div>
    </div>

    <script>
        const form = document.getElementById('shareCodeForm');
        const input = document.getElementById('shareCodeInput');
        const resultDiv = document.getElementById('result');
        
        const apiEndpoints = [
            { name: 'Primary (Moon Moon)', url: 'https://csreplay.moon-moon.tech', type: 'standard' },
            { name: 'Backup 1 (Cloudflare)', url: 'https://appeared-cite-reach-fy.trycloudflare.com', type: 'standard' },
            { name: 'Backup 2 (Moon Moon 2)', url: 'https://csreplay2.moon-moon.tech', type: 'standard' },
            { name: 'Backup 3 (Xify)', url: 'https://api.xify.pro/api/demo/extract', type: 'xify' }
        ];

        function fetchWithTimeout(resource, options = {}, timeout = 20000) {
            return new Promise((resolve, reject) => {
                const controller = new AbortController();
                const id = setTimeout(() => {
                    controller.abort();
                    reject(new Error('Request timed out'));
                }, timeout);
                
                fetch(resource, { ...options, signal: controller.signal })
                    .then(response => {
                        clearTimeout(id);
                        resolve(response);
                    })
                    .catch(error => {
                        clearTimeout(id);
                        reject(error);
                    });
            });
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const userInput = input.value.trim();
            const codes = userInput.split('\n').map(line => line.trim()).filter(line => line);

            if (codes.length === 0) {
                displayError('Please enter at least one Share Code or Link.');
                return;
            }

            setLoading(true);
            resultDiv.innerHTML = `
                <div class="w-full">
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-blue-200">Processing...</span>
                        <span id="progressText" class="text-sm font-medium text-blue-200">0 / ${codes.length}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <ul id="bulkResult" class="mt-4 text-left text-sm space-y-2 max-h-64 overflow-y-auto"></ul>
                </div>
            `;
            
            await processCodes(codes);
            setLoading(false);
        }

        async function processCodes(codes) {
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');
            const bulkResultList = document.getElementById('bulkResult');
            let completed = 0;
            const successfulResults = [];
            const failedCodes = [];
            
            for (const code of codes) {
                const result = await processSingleCode(code);
                
                if (result.status === 'success') {
                    successfulResults.push(result);
                } else if (result.status === 'error') {
                    failedCodes.push(result.code);
                }
                
                renderResult(result);
                completed++;
                progressText.textContent = `${completed} / ${codes.length}`;
                progressBar.style.width = `${(completed / codes.length) * 100}%`;

                await new Promise(resolve => setTimeout(resolve, 3000));
            }

            if (successfulResults.length > 0) {
                appendCopyAllButton(successfulResults.map(r => r.link));
                appendDownloadAllButton(successfulResults);
            }
            if (failedCodes.length > 0) {
                appendRetryAllButton(failedCodes);
            }
        }

        async function processSingleCode(code, retries = 1) {
            if (code.includes('csstats.gg/match/')) {
                return { code, error: 'CSstats.gg links must be resolved manually.', status: 'manual' };
            }

            const match = code.match(/(CSGO-[a-zA-Z0-9]{5}-[a-zA-Z0-9]{5}-[a-zA-Z0-9]{5}-[a-zA-Z0-9]{5}-[a-zA-Z0-9]{5})/);
            if (!match || !match[0]) {
                return { code, error: 'Invalid format.', status: 'error' };
            }
            const shareCode = match[0];

            try {
                const { response, endpoint } = await fetchWithFallback(shareCode);
                const data = await response.json();
                const downloadLink = endpoint.type === 'xify' ? data.downloadUrl : data.downloadLink;
                return { code, link: downloadLink, status: 'success', endpoint };
            } catch (err) {
                if (retries > 0) {
                    console.log(`Processing for ${code} failed. Waiting 5 seconds to retry...`);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    return processSingleCode(code, retries - 1);
                }
                return { code, error: err.message, status: 'error' };
            }
        }

        async function fetchWithFallback(shareCode) {
            let lastError = 'All API endpoints are unreachable.';
            for (const endpoint of apiEndpoints) {
                try {
                    let response;
                    if (endpoint.type === 'xify') {
                        response = await fetchWithTimeout(endpoint.url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ shareCode }),
                        });
                    } else {
                        response = await fetchWithTimeout(`${endpoint.url}/decode`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ shareCode }),
                        });
                    }
                    if (response.ok) {
                        return { response, endpoint };
                    }
                    const errorData = await response.json().catch(() => null);
                    if (errorData && errorData.error) lastError = errorData.error;
                } catch (error) {
                    if (error instanceof Error) lastError = error.message;
                }
            }
            throw new Error(lastError);
        }

        function renderResult(result) {
            const bulkResultList = document.getElementById('bulkResult');
            const li = document.createElement('li');
            li.className = 'p-2 rounded-md';
            li.dataset.code = result.code;

            if (result.status === 'success') {
                let downloadButtonHtml = '';
                if (result.endpoint.type === 'standard') {
                    const proxyUrl = `${result.endpoint.url}/download?url=${encodeURIComponent(result.link)}`;
                    downloadButtonHtml = `<a href="${proxyUrl}" download="${result.link.split('/').pop()}" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-2 rounded">Download</a>`;
                } else {
                    downloadButtonHtml = `<span class="text-xs text-gray-400">(No Proxy)</span>`;
                }
                li.innerHTML = `<div class="flex justify-between items-center">
                                    <span class="text-green-400 font-bold">SUCCESS:</span>
                                    ${downloadButtonHtml}
                                </div>
                                <p class="text-gray-400 text-xs mt-1">${result.code}</p>`;
            } else if (result.status === 'manual') {
                li.innerHTML = `<div class="flex justify-between items-center">
                                    <span class="text-yellow-400 font-bold">MANUAL:</span>
                                    <a href="/help.html" target="_blank" class="text-yellow-400 hover:underline text-xs">See Help Guide</a>
                                </div>
                                <p class="text-gray-400 text-xs mt-1">${result.code}</p>`;
            } else {
                li.innerHTML = `<div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-bold text-red-400">FAILED:</span>
                                        <span class="text-red-300 text-xs ml-2">${result.error}</span>
                                    </div>
                                    <button onclick="retrySingle(this)" class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-bold py-1 px-2 rounded">Retry</button>
                                </div>
                                <p class="text-gray-400 text-xs mt-1">${result.code}</p>`;
            }
            bulkResultList.appendChild(li);
        }

        async function retrySingle(button) {
            const li = button.closest('li');
            const code = li.dataset.code;
            li.innerHTML = `<div class="flex items-center"><svg class="animate-spin h-4 w-4 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Retrying...</div><p class="text-gray-400 text-xs mt-1">${code}</p>`;
            
            const result = await processSingleCode(code);
            
            li.innerHTML = ''; // Clear it first
            renderResult(result);
        }

        function appendCopyAllButton(links) {
            const copyAllButton = document.createElement('button');
            copyAllButton.id = 'copyAllButton';
            copyAllButton.className = 'mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg';
            copyAllButton.textContent = `Copy All ${links.length} Links`;
            document.getElementById('bulkResult').appendChild(copyAllButton);

            copyAllButton.addEventListener('click', () => {
                const allLinks = links.join('\n');
                const textArea = document.createElement('textarea');
                textArea.value = allLinks;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyAllButton.textContent = 'Copied!';
                    setTimeout(() => { copyAllButton.textContent = `Copy All ${links.length} Links`; }, 2000);
                } catch (err) {
                    console.error('Failed to copy all links: ', err);
                }
                document.body.removeChild(textArea);
            });
        }
        
        function appendDownloadAllButton(results) {
            const downloadAllButton = document.createElement('button');
            downloadAllButton.id = 'downloadAllButton';
            downloadAllButton.className = 'mt-2 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg';
            downloadAllButton.textContent = `Download All ${results.length} Demos`;
            document.getElementById('bulkResult').appendChild(downloadAllButton);

            downloadAllButton.addEventListener('click', async () => {
                downloadAllButton.disabled = true;
                for (let i = 0; i < results.length; i++) {
                    const result = results[i];
                    if (result.endpoint.type !== 'standard') continue; // Skip non-proxyable links
                    
                    downloadAllButton.textContent = `Downloading ${i + 1} of ${results.length}...`;
                    const proxyUrl = `${result.endpoint.url}/download?url=${encodeURIComponent(result.link)}`;
                    const a = document.createElement('a');
                    a.href = proxyUrl;
                    a.download = result.link.split('/').pop();
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                downloadAllButton.textContent = `Download All ${results.length} Demos`;
                downloadAllButton.disabled = false;
            });
        }

        function appendRetryAllButton(failedCodes) {
            const retryAllButton = document.createElement('button');
            retryAllButton.id = 'retryAllButton';
            retryAllButton.className = 'mt-4 w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg';
            retryAllButton.textContent = `Retry All ${failedCodes.length} Failed`;
            document.getElementById('bulkResult').appendChild(retryAllButton);

            retryAllButton.addEventListener('click', async () => {
                retryAllButton.disabled = true;
                retryAllButton.textContent = 'Retrying all...';
                
                const failedItems = Array.from(document.querySelectorAll('#bulkResult li')).filter(li => !li.innerHTML.includes('SUCCESS'));
                const codesToRetry = failedItems.map(li => li.dataset.code);
                
                failedItems.forEach(li => li.remove());
                
                await processCodes(codesToRetry);
                retryAllButton.disabled = false;
                retryAllButton.textContent = `Retry All Failed`;
            });
        }

        function displayError(message) {
            resultDiv.innerHTML = `<p class="text-red-400 font-semibold">${message}</p>`;
        }
        
        function setLoading(isLoading) {
            const button = document.getElementById('submitButton');
            const spinner = document.getElementById('spinner');
            const buttonText = document.getElementById('buttonText');
            button.disabled = isLoading;
            spinner.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Processing...' : 'Get Download Links';
        }

        form.addEventListener('submit', handleSubmit);
    </script>
</body>
</html>
