<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Demo Link Generator</title>
    <!-- Using Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A little extra style for a nice gradient background */
        body {
            background: linear-gradient(to right, #1e3a8a, #3b82f6);
        }
        /* Style for the result link */
        #result a {
            word-break: break-all;
        }
    </style>
</head>
<body class="font-sans antialiased text-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-gray-800 bg-opacity-50 backdrop-blur-md rounded-2xl shadow-2xl p-8 max-w-lg w-full mx-4">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">CS2 Demo Link Generator</h1>
            <p class="text-blue-200">A tool for users of <a href="https://cswatch.in/" target="_blank" rel="noopener noreferrer" class="underline hover:text-white">CSWatch.in</a> to easily get demo download links.</p>
        </div>

        <!-- How to Find Your Code Section -->
        <div class="mb-8 text-left bg-gray-900 bg-opacity-50 p-4 rounded-lg">
            <h2 class="font-bold text-white mb-2">How to get your Share Code:</h2>
            <ol class="list-decimal list-inside text-sm text-blue-200 space-y-1">
                <li>In CS2, go to "Watch" &rarr; "Your Matches".</li>
                <li>Select a match and click "Copy Share Link".</li>
                <li><strong>Or:</strong> If you have a `steam://` link, just paste the whole link below!</li>
            </ol>
        </div>

        <!-- Input Form -->
        <form id="shareCodeForm">
            <div class="mb-4">
                <label for="shareCodeInput" class="sr-only">Share Code</label>
                <input 
                    type="text" 
                    id="shareCodeInput"
                    placeholder="Paste your Share Code or Link here..."
                    class="w-full px-4 py-3 bg-gray-700 text-white border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-300"
                    required
                >
            </div>
            <button 
                type="submit" 
                id="submitButton"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105 flex items-center justify-center"
            >
                <!-- Spinner icon for loading state -->
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="buttonText">Get Download Link</span>
            </button>
        </form>

        <!-- Result Display Area -->
        <div id="result" class="mt-8 p-6 bg-gray-900 rounded-lg text-center min-h-[80px] flex items-center justify-center transition-all duration-300">
            <p class="text-gray-400">Your link will appear here...</p>
        </div>

        <!-- Footer with Creator Tag and Counter -->
        <div class="text-center mt-8 text-blue-200 text-sm space-y-2">
            <p>
                Created by <a href="https://steamcommunity.com/id/norton99/" target="_blank" rel="noopener noreferrer" class="font-bold underline hover:text-white">norton99</a>
            </p>
            <p>
                Special thanks to <a href="https://github.com/m0onmo0n" target="_blank" rel="noopener noreferrer" class="font-bold underline hover:text-white">Moon Moon</a> for server hosting.
            </p>
            <div class="flex items-center justify-center space-x-2">
                <span>API Status:</span>
                <span id="apiStatus" class="h-3 w-3 rounded-full bg-yellow-500" title="Checking..."></span>
                <span class="font-bold">|</span>
                <span>Successful links generated: <span id="parseCounter" class="font-bold">...</span></span>
            </div>
        </div>

    </div>

    <script>
        const form = document.getElementById('shareCodeForm');
        const input = document.getElementById('shareCodeInput');
        const resultDiv = document.getElementById('result');
        const submitButton = document.getElementById('submitButton');
        const spinner = document.getElementById('spinner');
        const buttonText = document.getElementById('buttonText');
        const counterSpan = document.getElementById('parseCounter');
        const apiStatusSpan = document.getElementById('apiStatus');
        
        const apiEndpoints = [
            'https://csreplay.moon-moon.tech',
            'https://improve-pig-banner-prove.trycloudflare.com'
        ];
        let activeApiEndpoint = apiEndpoints[0]; // Store the active endpoint

        async function fetchWithFallback(path, options) {
            for (const endpoint of apiEndpoints) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5-second timeout

                try {
                    console.log(`Trying API endpoint: ${endpoint}${path}`);
                    const response = await fetch(`${endpoint}${path}`, {
                        ...options,
                        signal: controller.signal // Pass the abort signal to fetch
                    });
                    
                    clearTimeout(timeoutId); // Clear the timeout if the request succeeds

                    if (response.ok) {
                        console.log(`Success with endpoint: ${endpoint}${path}`);
                        activeApiEndpoint = endpoint;
                        return response;
                    }
                    console.warn(`Request to ${endpoint}${path} failed with status: ${response.status}`);
                } catch (error) {
                    clearTimeout(timeoutId); // Clear the timeout if the request fails
                    console.error(`Request to ${endpoint}${path} failed:`, error);
                }
            }
            throw new Error('All API endpoints are unreachable.');
        }

        async function checkApiStatus() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            try {
                const response = await fetch(`${apiEndpoints[0]}/count`, { signal: controller.signal });
                clearTimeout(timeoutId);
                apiStatusSpan.className = `h-3 w-3 rounded-full ${response.ok ? 'bg-green-500' : 'bg-red-500'}`;
                apiStatusSpan.title = response.ok ? 'Online' : 'Offline';
            } catch (error) {
                clearTimeout(timeoutId);
                apiStatusSpan.className = 'h-3 w-3 rounded-full bg-red-500';
                apiStatusSpan.title = 'Offline';
            }
        }

        async function getInitialCount() {
            try {
                // We don't need a long timeout here, just a quick check.
                const response = await fetch(`${apiEndpoints[0]}/count`);
                const data = await response.json();
                counterSpan.textContent = data.count;
            } catch (error) {
                counterSpan.textContent = 'N/A';
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            let shareCode = input.value.trim();
            const match = shareCode.match(/(CSGO-[a-zA-Z0-9]{5}-[a-zA-Z0-9]{5}-[a-zA-Z0-9]{5}-[a-zA-Z0-9]{5}-[a-zA-Z0-9]{5})/);
            if (match && match[0]) {
                shareCode = match[0];
                input.value = shareCode;
            }
            if (!shareCode) {
                displayError('Please enter a valid Share Code or Link.');
                return;
            }
            setLoading(true);
            try {
                const response = await fetchWithFallback('/decode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shareCode: shareCode }),
                });
                const data = await response.json();
                displayLink(data.downloadLink);
                if (data.newCount !== undefined) {
                    counterSpan.textContent = data.newCount;
                }
            } catch (error) {
                displayError(error.message);
            } finally {
                setLoading(false);
            }
        });

        function displayLink(link) {
            const proxyUrl = `${activeApiEndpoint}/download?url=${encodeURIComponent(link)}`;
            const filename = link.split('/').pop();

            resultDiv.innerHTML = `
                <div class="flex flex-col items-center space-y-4 text-center">
                    <p class="font-bold text-white">Your download is ready!</p>
                    <a 
                        href="${proxyUrl}" 
                        download="${filename}"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                    >Download Demo</a>
                    <button id="copyButton" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-300">
                        Copy Original Link
                    </button>
                </div>
            `;
            document.getElementById('copyButton').addEventListener('click', () => {
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const copyButton = document.getElementById('copyButton');
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => { copyButton.textContent = 'Copy Original Link'; }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(textArea);
            });
        }

        function displayError(message) {
            resultDiv.innerHTML = `<p class="text-red-400 font-semibold">${message}</p>`;
        }

        function setLoading(isLoading) {
            submitButton.disabled = isLoading;
            spinner.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Decoding...' : 'Get Download Link';
            submitButton.classList.toggle('opacity-75', isLoading);
            submitButton.classList.toggle('cursor-not-allowed', isLoading);
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkApiStatus();
            getInitialCount();
            setInterval(checkApiStatus, 30000);
        });
    </script>
</body>
</html>
